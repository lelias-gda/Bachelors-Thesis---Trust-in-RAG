<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>RAG System</title>
    <script src="https://kit.fontawesome.com/ce0510aed4.js" crossorigin="anonymous"></script>
    <style>
        /* Grundlegende Einstellungen */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Helvetica", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #fafafa
        }

        body.dark-mode {
            background-color: #2c2c2c;
            color: #e0e0e0
        }

        /* Top-Bar mit Logo */
        .top-bar {
            background-color: #f2f2f2;
            /* helle Hintergrundfarbe */
            position: relative;
            padding: 10px 0;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        body.dark-mode .top-bar {
            background-color: #242424;
            border-bottom: 1px solid #353535
        }

        .top-bar img {
            max-height: 80px;
        }

        /*
        Reset-Button
        */
        .reset-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            left: 2.5%;
            background-color: rgba(36, 36, 36, 0);
            border: none;
            outline: none;
            cursor: pointer;
            font-size: 2em;

        }

        body.dark-mode .reset-button {
            color: #e0e0e0
        }

        /*
         --Toggle für Dark Mode--
         */
        .mode-toggle {
            position: absolute;
            top: 50%;
            right: 2.5%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
        }

        .mode-icon {
            margin-right: 70px;
            font-size: 1.8em;
        }


        .top-bar .switch {
            position: absolute;
            top: 50%;
            right: 2.5%;
            transform: translateY(-50%)
        }

        .switch {
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            background-color: #ccc;
            border-radius: 24px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: 0.4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        /* Wenn der Switch aktiviert ist */
        #modeToggle:checked+.slider {
            background-color: #535353;
        }

        #modeToggle:checked+.slider:before {
            transform: translateX(26px);
        }

        /*
        ---- Chat-Bereich, der scrollen kann ----
        */
        .chat-container {
            flex: 1;
            /* Nimmt den verfügbaren Platz im Vertikalen ein */
            overflow-y: auto;
            /* Ermöglicht Scrollen, wenn zu viel Inhalt vorhanden ist */
            padding: 20px;
            width: 80%;
            align-self: center;
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
        }

        /* 
        --- Nachricht allgemein --- 
        */
        .message {
            max-width: 60%;
            font-family: "Helvetica";
            font-size:90%%
            /* Sprechblasenbreite begrenzen */
            margin-bottom: 10px;
            /* Abstand unter jeder Nachricht */
            padding: 10px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            /* Zeilenumbruch bei langen Wörtern */
            min-width: 0%
        }

        /* 
        --- Sender-Kennzeichnung über der Nachricht --- 
        */
        .sender {
            font-family: "Helvetica";
            font-size: 0.8em;
            color: #555;
            margin-bottom: 4px;
        }

        body.dark-mode .sender {
            color: #e2e2e2
        }

        /* 
        --- KI-Sprechblase ---
        */
        .ai {
            background-color: #B4CCD6;
            color: #333;
            /* Hellblau */
            margin-right: auto;
            /* Links ausrichten */
            align-self: flex-start
        }

        body.dark-mode .ai {
            background-color: #1D3457;
            color: #fafafa
        }

        /* 
        --- Nutzer*innen-Sprechblase ---
        */
        .human {
            max-width: 40%;
            background-color: #598596;
            color: #141414;
            /* Dunkelblau */
            margin-left: auto;
            /* Rechts ausrichten */
            align-self: flex-end;
            margin-right: 10%
        }

        body.dark-mode .human {
            background-color: #1e4757;
            color: #fafafa;
        }

        /* 
        --- Quellenliste ---
        */
        .sources {
            font-family: "Helvetica";
            margin-top: 10px;
            font-size: 0.75em;
            color: #555;
            line-height: 1.3em;
        }

        .sources ul {
            padding-left: 20px;
            margin-top: 5px;
        }

        body.dark-mode .sources {
            color: #b6b6b6
        }

        /* 
        --- Footer-Area ---
         */
        .chat-input-container {
            font-family: "Helvetica";
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #ddd;
            background-color: #f2f2f2;
            padding: 10px;
            height: 15%
        }

        body.dark-mode .chat-input-container {
            border-top: 1px solid #353535;
            background-color: #242424;
        }

        /* 
        --- Textarea ---
         */
        .chat-input-container textarea {
            font-family: "Helvetica";
            width: 70%;
            align-items: center;
            resize: none;
            height: 80%;
            font-size: 1.1em;
            border: none;
            border-radius: 20px;
            padding: 10px;
            outline: none;
            color: #0f0f0f;
        }

        body.dark-mode .chat-input-container textarea {
            background-color: #333333;
            color: #fafafa;
        }

        /* 
        --- Button ---
         */
        .chat-input-container button {
            width: 60px;
            margin-left: 10px;
            padding-right: 5px;
            height: 60px;
            font-size: 2em;
            cursor: pointer;
            border: 0;
            border-radius: 100%;
            background-color: #ccc;
            color: #0f0f0f;
        }

        body.dark-mode .chat-input-container button {
            background-color: #f0f0f0;
            color: #0f0f0f
        }

        .chat-input-container button:hover {
            color: #000;
            background-color: #a3a3a3;
            box-shadow: 10px 10px 10px -4px rgba(36, 36, 36, 0.2);
        }

        body.dark-mode .chat-input-container button:hover {
            color: #252525;
            background-color: #ffffff;
            box-shadow: 10px 10px 10px -4px rgba(240, 240, 240, 0.2);
        }

        /* Overlay, das den ganzen Bildschirm abdeckt */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            /* halbtransparent */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* CSS-Spinnereffekt */
        .spinner {
            border: 12px solid #f3f3f3;
            border-top: 12px solid #1D3457;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>


</head>

<body class="dark-mode">
    <!-- Top-Bar mit Logo -->
    <div class="top-bar">
        <form action="/reset" method="post">
            <button class="reset-button">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </form>
        <!-- Hier dein Logo einbinden -->
        <img src="{{ url_for('static', filename='FunkFabrik-Logo.png') }}" alt="FunkFabrik Logo">
        <div class="mode-toggle">
            <i id="modeIcon" class="mode-icon fas fa-moon"></i>
            <label class="switch">
                <input type="checkbox" id="modeToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <!-- Chat-Verlauf -->
    <div class="chat-container" id="chat">
        {% for msg in chat_history %}
        {% if msg.type == "ai" %}
        <!-- KI-Nachricht -->
        <div class="sender">FunkFabrik-KI</div>
        <div class="message ai">
            {{ msg.content }}
            {% if msg.sources %}
            <div class="sources">
                <strong>Quellen</strong>
                <ul>
                    {% for source, score in msg.sources %}
                    <li>{{ source.metadata.get("source") | replace("PDFs\\", "") }}<!-- , Suchscore: {{ (score*100)|round(1)
                        }}% --></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% elif msg.type == "human" %}
        <!-- Benutzer-Nachricht -->
        <div class="sender" style="align-self:flex-end; margin-right: 10.3%">Du</div>
        <div class="message human">
            {{ msg.content }}
        </div>
        {% endif %}
        {% endfor %}
        <div id="loadingOverlay" style="display: none;">
            <div class="spinner"></div>
        </div>
    </div>
    <!-- Lade-Overlay -->
    


    <!-- Eingabebereich am unteren Rand -->
    <form id="chatForm" action="/" class="chat-input-container">
        <textarea id="chatInput" name="query" placeholder="Gib hier deine Frage ein"></textarea>
        <button id="submitBtn" type="submit">
            <i class="fa-solid fa-paper-plane" alt="Senden"></i>
        </button>
    </form>
</body>

<script>
    const form = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');

    chatInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            //chatForm.submit();
            genNewMsg()
            event.preventDefault();
        }
    }
    )
    const modeToggle = document.getElementById('modeToggle');
    const modeIcon = document.getElementById('modeIcon');
    //https://github.com/binary-hood/ChatBot/blob/main/templates/chat.html
    modeToggle.addEventListener('change', function () {
        if (this.checked) {
            // Nachtmodus aktivieren:
            document.body.classList.add('dark-mode');
            // Icon auf "Mond" umstellen:
            modeIcon.classList.remove('fa-sun');
            modeIcon.classList.add('fa-moon');
        } else {
            // Tagmodus aktivieren:
            document.body.classList.remove('dark-mode');
            // Icon auf "Sonne" umstellen:
            modeIcon.classList.remove('fa-moon');
            modeIcon.classList.add('fa-sun');
        }
    });

    function scrollToBottom() {
        var messageBody = document.getElementById("chat");
        messageBody.scrollTop = messageBody.scrollHeight;
    }
    function genNewMsg() {
        var rawText = $("#chatInput").val();

        var userHtml =
            '<div class="sender" style="align-self:flex-end; margin-right: 10.3%">Du</div>' +
            '<div class="message human">' +
            rawText +
            '</div>'

        $("#chatInput").val("");
        $("#chat").append(userHtml);
        scrollToBottom();

        $.ajax({
            data: {
                query: rawText,
            },
            type: "POST",
            url: "/",
        }).done(function (data) {
            var sourcesHTML = '';
            if (data.sources && data.sources.length > 0) {
                sourcesHTML += '<div class= "sources"> <strong> Quellen </strong> <ul>';
                for (var i = 0; i < data.sources.length; i++) {
                    var source = data.sources[i];
                    // Hier passen wir die Darstellung der Quelle an (z.B. Pfadbereinigung, Suchscore formatieren)
                    sourcesHTML += '<li>' + source.metadata.source.replace("PDFs\\", "") + '</li>';
                    /* sourcesHTML += '<li>' + source.metadata.source.replace("PDFs\\", "") + ', Suchscore: ' + (source.score * 100).toFixed(1) + '%</li>'; */
                    //console.log("Test "+ source.metadata.source)
                }
                sourcesHTML += '</ul></div>';
            }
            var botHtml =
                '<div class="sender">FunkFabrik-KI</div>' +
                '<div class="message ai">' +
                data.message +
                sourcesHTML +
                '</div>';
            $("#chat").append($.parseHTML(botHtml));
            scrollToBottom();
        });
        event.preventDefault();
    }
    $(document).ready(function () {
        $("#chatForm").on("submit", function (event) {
            genNewMsg()
        });
    });

    $(document).ajaxStart(function () {
        $("#loadingOverlay").fadeIn();
    }).ajaxStop(function () {
        $("#loadingOverlay").fadeOut();
    });
</script>
<!--  <script>
    const chatForm = document.getElementById('chatForm');
    chatForm.addEventListener('submit', function (event) {
        // Button deaktivieren
        chatForm.disabled = true;
        // Nach 5 Sekunden wieder aktivieren
        setTimeout(() => {
            chatForm.disabled = false;
        }, 5000);
    });
</script>  -->



</html>